<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Laporan Bertugas Guru - Sistem Rekod</title>
    <script src="sheets-api.js" defer></script>
    <style>
        :root {
            --primary-color: #1a237e;
            --secondary-color: #0d47a1;
            --accent-color: #2962ff;
            --text-color: #333;
            --border-color: #e0e0e0;
            --success-color: #2e7d32;
            --danger-color: #c62828;
            --background-color: #f5f5f5;
            --title-size: 2rem;
            --subtitle-size: 2rem;
            --normal-text: 1rem;
            --small-text: 0.9rem;
            --holiday-color: #e0e0e0;
            --today-color: #fff3cd;
            --past-due-color: #ffcdd2;
            --submitted-color: #64b5f6;
            --checked-color: #a5d6a7;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        html, body {
            min-height: 100%;
            overflow-y: auto;
            background-color: var(--background-color);
        }

        .header {
            background-color: var(--primary-color);
            color: white;
            padding: 1.5rem 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0 20px;
            text-align: center;
        }

        .header-text {
            width: 100%;
        }

        .school-name {
            font-size: calc(var(--title-size) * 1.2);
            margin-bottom: 4px;
            line-height: 1.4;
            font-weight: bold;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
        }

        .header h1 {
            font-size: var(--subtitle-size);
            margin-top: 15px;
            color: white;
        }

        .container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0 20px;
            min-height: calc(100vh - 150px);
            display: flex;
            flex-direction: column;
        }

        h1 {
            text-align: center;
            margin: 20px 0;
            color: var(--primary-color);
            font-size: 1.5rem;
        }

        .calendar-container {
            background-color: #fff;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            padding: 20px;
            flex: 1;
            min-height: 0;
            display: flex;
            flex-direction: column;
            border: 1px solid var(--border-color);
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border-color);
        }

        .calendar-header button {
            background: var(--primary-color);
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .calendar-header button:hover {
            background: var(--secondary-color);
        }

        #monthDisplay {
            font-size: 1.2rem;
            color: var(--primary-color);
            font-weight: 600;
        }

        .weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            text-align: center;
            font-weight: bold;
            margin-bottom: 10px;
            color: var(--primary-color);
            padding: 10px 0;
        }

        .days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            grid-auto-rows: 1fr;
            gap: 5px;
            flex: 1;
        }

        .day {
            border: 1px solid var(--border-color);
            padding: 10px;
            text-align: center;
            cursor: pointer;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            font-weight: 500;
            position: relative;
        }

        .day:hover {
            background-color: var(--accent-color);
            color: white;
            transform: scale(1.05);
        }

        .day.holiday {
            background-color: var(--holiday-color);
            cursor: not-allowed;
            color: #666;
        }

        .day.today {
            background-color: var(--today-color);
        }

        .day.past-due {
            background-color: var(--past-due-color);
        }

        .day.submitted {
            background-color: var(--submitted-color);
        }

        .day.checked {
            background-color: var(--checked-color);
        }

        .day.has-report {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            overflow-y: auto;
        }

        .modal-content {
            background-color: #fff;
            margin: 3vh auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 800px;
            max-height: calc(100vh - 40px);
            overflow-y: auto;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .modal-content::-webkit-scrollbar {
            width: 8px;
        }

        .modal-content::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .modal-content::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        .modal-content::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .close {
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-size: var(--normal-text);
            font-weight: 500;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            resize: vertical;
        }

        button[type="submit"] {
            background-color: var(--success-color);
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            width: 100%;
            font-weight: 600;
            transition: background-color 0.3s ease;
        }

        button[type="submit"]:hover {
            background-color: #1b5e20;
        }

        @media screen and (max-height: 600px) {
            .modal-content {
                margin: 2vh auto;
            }
            
            .form-group {
                margin-bottom: 10px;
            }
            
            .form-group textarea {
                rows: 3;
            }
        }

        @media screen and (max-width: 768px) {
            :root {
                --title-size: 1.5rem;
                --subtitle-size: 1.2rem;
                --normal-text: 0.9rem;
                --small-text: 0.8rem;
            }

            .container {
                padding: 0 5px;
                height: calc(100vh - 120px);
            }

            .calendar-container {
                padding: 10px 5px;
            }

            .day {
                padding: 5px;
                font-size: 12px;
            }

            .modal {
                padding: 0;
            }

            .close {
                position: fixed;
                top: 10px;
                right: 10px;
                z-index: 1001;
                color: var(--primary-color);
            }

            .modal-content {
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
            }

            input[type="time"],
            select,
            textarea {
                font-size: 16px !important;
            }
        }

        .sub-form {
            margin-bottom: 10px;
            padding-left: 15px;
        }

        .cleanliness-section,
        .discipline-case {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-top: 10px;
        }

        select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: white;
        }

        #dutyLocation {
            background-color: #e9ecef;
        }

        .likert-scale {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            padding: 5px 0;
        }

        .likert-scale input[type="radio"] {
            display: none;
        }

        .likert-scale label {
            flex: 1;
            text-align: center;
            padding: 8px;
            border: 1px solid #ddd;
            margin: 0 2px;
            cursor: pointer;
            border-radius: 4px;
            font-size: 14px;
        }

        .likert-scale input[type="radio"]:checked + label {
            background-color: #007bff;
            color: white;
            border-color: #007bff;
        }

        .scale-legend {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }

        .scale-legend span {
            flex: 1;
            text-align: center;
        }

        .button-group {
            display: flex;
            gap: 10px;
        }

        .button-group button {
            flex: 1;
        }

        .delete-button {
            background-color: var(--danger-color) !important;
        }

        .delete-button:hover {
            background-color: #b71c1c !important;
        }

        /* Confirmation dialog styling */
        .confirm-dialog {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
            text-align: center;
        }

        .confirm-dialog .button-group {
            margin-top: 20px;
        }

        .scale-description small {
            font-size: var(--small-text);
            display: block;
            margin: 10px 0;
            color: #666;
        }

        .modal-content h2 {
            font-size: var(--subtitle-size);
            color: var(--primary-color);
            margin-bottom: 15px;
        }

        .modal-content h3 {
            font-size: var(--normal-text);
            color: var(--text-color);
            margin-bottom: 20px;
        }

        /* Add legend */
        .calendar-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 20px;
            padding: 10px;
            border-top: 1px solid var(--border-color);
        }

        .legend-item {
            display: flex;
            align-items: center;
            font-size: 0.9rem;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            margin-right: 8px;
            border-radius: 4px;
            border: 1px solid var(--border-color);
        }

        /* Enhanced verify all button */
        .verify-all-container {
            display: flex;
            justify-content: flex-end;
            padding: 10px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .verify-all-button {
            background: var(--primary-color);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .verify-all-button:hover {
            background: var(--secondary-color);
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* Enhanced security dialog */
        .security-dialog {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            text-align: center;
            max-width: 400px;
            width: 90%;
        }

        .security-dialog h3 {
            color: var(--primary-color);
            margin-bottom: 15px;
            font-size: 1.3rem;
        }

        .security-input {
            width: 100%;
            padding: 12px;
            margin: 20px 0;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            text-align: center;
            font-size: 1.1rem;
            transition: border-color 0.3s ease;
        }

        .security-input:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        /* Enhanced scale description */
        .scale-details {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .scale-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: #f8f9fa;
        }

        .scale-number {
            background: var(--primary-color);
            color: white;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            margin-bottom: 8px;
            font-weight: bold;
        }

        .scale-text {
            font-size: 0.9rem;
            color: var(--text-color);
            line-height: 1.2;
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="header-text">
                <div class="school-name">
                    <span style="font-family: 'Microsoft YaHei', '微软雅黑'">巴音新村华文小学</span>
                    <span>SJKC KG BARU PAJAM</span>
                </div>
                <h1>Sistem Rekod Laporan Bertugas Guru</h1>
            </div>
        </div>
    </header>

    <div class="container">
        <div class="calendar-container">
            <div class="calendar-header">
                <button id="prevMonth">&lt;</button>
                <h2 id="monthDisplay"></h2>
                <button id="nextMonth">&gt;</button>
            </div>
            <div class="verify-all-container">
                <button id="verifyAllBtn" class="verify-all-button">
                    <i class="fas fa-check-double"></i>
                    Sahkan Semua Laporan
                </button>
            </div>
            <div class="calendar" id="calendar">
                <div class="weekdays">
                    <div>Ahd</div>
                    <div>Isn</div>
                    <div>Sel</div>
                    <div>Rab</div>
                    <div>Kha</div>
                    <div>Jum</div>
                    <div>Sab</div>
                </div>
                <div id="calendarDays" class="days"></div>
            </div>
            <div class="calendar-legend">
                <div class="legend-item">
                    <div class="legend-color" style="background-color: var(--holiday-color);"></div>
                    <span>Cuti</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: var(--today-color);"></div>
                    <span>Hari Ini</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: var(--past-due-color);"></div>
                    <span>Belum Hantar</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: var(--submitted-color);"></div>
                    <span>Belum Disemak</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: var(--checked-color);"></div>
                    <span>Telah Disemak</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for duty report -->
    <div id="reportModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Laporan Guru Bertugas</h2>
            <h3 id="selectedDate"></h3>
            <form id="dutyForm">
                <div class="form-group">
                    <label for="teacherName">Nama Guru Bertugas:</label>
                    <input type="text" id="teacherName" required placeholder="Masukkan nama guru bertugas">
                </div>
                <div class="form-group">
                    <label for="dutyLocation">Tempat Bertugas:</label>
                    <input type="text" id="dutyLocation" value="Kawasan Sekolah" readonly>
                </div>
                <div class="form-group">
                    <label>Keadaan Kebersihan & Disiplin:</label>
                    <div class="cleanliness-section">
                        <div class="scale-description">
                            <div class="scale-details">
                                <div class="scale-item">
                                    <span class="scale-number">1</span>
                                    <span class="scale-text">Sangat Tidak Memuaskan</span>
                                </div>
                                <div class="scale-item">
                                    <span class="scale-number">2</span>
                                    <span class="scale-text">Tidak Memuaskan</span>
                                </div>
                                <div class="scale-item">
                                    <span class="scale-number">3</span>
                                    <span class="scale-text">Memuaskan</span>
                                </div>
                                <div class="scale-item">
                                    <span class="scale-number">4</span>
                                    <span class="scale-text">Baik</span>
                                </div>
                                <div class="scale-item">
                                    <span class="scale-number">5</span>
                                    <span class="scale-text">Sangat Baik</span>
                                </div>
                            </div>
                        </div>
                        <div class="sub-form">
                            <label>Bilik Darjah:</label>
                            <div class="likert-scale" id="classroomStatus">
                                <input type="radio" name="classroom" value="1" id="classroom1">
                                <label for="classroom1">1</label>
                                <input type="radio" name="classroom" value="2" id="classroom2">
                                <label for="classroom2">2</label>
                                <input type="radio" name="classroom" value="3" id="classroom3">
                                <label for="classroom3">3</label>
                                <input type="radio" name="classroom" value="4" id="classroom4">
                                <label for="classroom4">4</label>
                                <input type="radio" name="classroom" value="5" id="classroom5">
                                <label for="classroom5">5</label>
                            </div>
                        </div>
                        <div class="sub-form">
                            <label>Kaki Lima:</label>
                            <div class="likert-scale" id="corridorStatus">
                                <input type="radio" name="corridor" value="1" id="corridor1">
                                <label for="corridor1">1</label>
                                <input type="radio" name="corridor" value="2" id="corridor2">
                                <label for="corridor2">2</label>
                                <input type="radio" name="corridor" value="3" id="corridor3">
                                <label for="corridor3">3</label>
                                <input type="radio" name="corridor" value="4" id="corridor4">
                                <label for="corridor4">4</label>
                                <input type="radio" name="corridor" value="5" id="corridor5">
                                <label for="corridor5">5</label>
                            </div>
                        </div>
                        <div class="sub-form">
                            <label for="maleBathroomStatus">Tandas Lelaki:</label>
                            <div class="likert-scale" id="maleBathroomStatus">
                                <input type="radio" name="maleBathroom" value="1" id="maleBathroom1">
                                <label for="maleBathroom1">1</label>
                                <input type="radio" name="maleBathroom" value="2" id="maleBathroom2">
                                <label for="maleBathroom2">2</label>
                                <input type="radio" name="maleBathroom" value="3" id="maleBathroom3">
                                <label for="maleBathroom3">3</label>
                                <input type="radio" name="maleBathroom" value="4" id="maleBathroom4">
                                <label for="maleBathroom4">4</label>
                                <input type="radio" name="maleBathroom" value="5" id="maleBathroom5">
                                <label for="maleBathroom5">5</label>
                            </div>
                        </div>
                        <div class="sub-form">
                            <label for="femaleBathroomStatus">Tandas Perempuan:</label>
                            <div class="likert-scale" id="femaleBathroomStatus">
                                <input type="radio" name="femaleBathroom" value="1" id="femaleBathroom1">
                                <label for="femaleBathroom1">1</label>
                                <input type="radio" name="femaleBathroom" value="2" id="femaleBathroom2">
                                <label for="femaleBathroom2">2</label>
                                <input type="radio" name="femaleBathroom" value="3" id="femaleBathroom3">
                                <label for="femaleBathroom3">3</label>
                                <input type="radio" name="femaleBathroom" value="4" id="femaleBathroom4">
                                <label for="femaleBathroom4">4</label>
                                <input type="radio" name="femaleBathroom" value="5" id="femaleBathroom5">
                                <label for="femaleBathroom5">5</label>
                            </div>
                        </div>
                        <div class="sub-form">
                            <label for="schoolAreaStatus">Kawasan Sekolah:</label>
                            <div class="likert-scale" id="schoolAreaStatus">
                                <input type="radio" name="schoolArea" value="1" id="schoolArea1">
                                <label for="schoolArea1">1</label>
                                <input type="radio" name="schoolArea" value="2" id="schoolArea2">
                                <label for="schoolArea2">2</label>
                                <input type="radio" name="schoolArea" value="3" id="schoolArea3">
                                <label for="schoolArea3">3</label>
                                <input type="radio" name="schoolArea" value="4" id="schoolArea4">
                                <label for="schoolArea4">4</label>
                                <input type="radio" name="schoolArea" value="5" id="schoolArea5">
                                <label for="schoolArea5">5</label>
                            </div>
                        </div>
                        <div class="sub-form">
                            <label for="canteenStatus">Kantin Sekolah:</label>
                            <div class="likert-scale" id="canteenStatus">
                                <input type="radio" name="canteen" value="1" id="canteen1">
                                <label for="canteen1">1</label>
                                <input type="radio" name="canteen" value="2" id="canteen2">
                                <label for="canteen2">2</label>
                                <input type="radio" name="canteen" value="3" id="canteen3">
                                <label for="canteen3">3</label>
                                <input type="radio" name="canteen" value="4" id="canteen4">
                                <label for="canteen4">4</label>
                                <input type="radio" name="canteen" value="5" id="canteen5">
                                <label for="canteen5">5</label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label>Kes Disiplin:</label>
                    <div class="discipline-case">
                        <div class="sub-form">
                            <label for="hasDisciplineCase">Perihal:</label>
                            <select id="hasDisciplineCase">
                                <option value="no">Tiada</option>
                                <option value="yes">Ada</option>
                            </select>
                        </div>
                        <div id="disciplineDetails" style="display: none;">
                            <div class="sub-form">
                                <label for="caseDescription">Keterangan Kes:</label>
                                <textarea id="caseDescription" rows="2" placeholder="Sila nyatakan keterangan kes"></textarea>
                            </div>
                            <div class="sub-form">
                                <label for="incidentLocation">Tempat Kejadian:</label>
                                <input type="text" id="incidentLocation">
                            </div>
                            <div class="sub-form">
                                <label for="incidentTime">Masa Berlaku:</label>
                                <input type="time" id="incidentTime">
                            </div>
                            <div class="sub-form">
                                <label for="actionTaken">Tindakan Diambil:</label>
                                <textarea id="actionTaken" rows="2"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="lostFound">Keciciran & Barang Dijumpai:</label>
                    <textarea id="lostFound" rows="3"></textarea>
                </div>
                <div class="button-group">
                    <button type="submit">Hantar Laporan</button>
                    <button type="button" id="deleteReport" class="delete-button">Padam Laporan</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add confirmation dialog -->
    <div id="confirmDialog" class="confirm-dialog">
        <p>Adakah anda pasti untuk memadam laporan ini?</p>
        <div class="button-group">
            <button onclick="confirmDelete(false)">Batal</button>
            <button onclick="confirmDelete(true)" class="delete-button">Padam</button>
        </div>
    </div>

    <!-- Update security dialog -->
    <div id="securityDialog" class="confirm-dialog security-dialog">
        <h3>🔒 Pengesahan Keselamatan</h3>
        <p>Sila masukkan kod keselamatan untuk mengesahkan laporan.</p>
        <input type="password" id="securityCode" class="security-input" placeholder="Masukkan kod keselamatan">
        <p id="securityError" class="error-message" style="display: none; color: red; margin-top: 10px;">
            Kod keselamatan tidak sah!
        </p>
        <div class="button-group">
            <button onclick="verifySecurityCode(false)" class="cancel-button">Batal</button>
            <button onclick="verifySecurityCode(true)" class="verify-button">Sahkan</button>
        </div>
    </div>

    <script>
        let currentDate = new Date();
        let selectedDate = null;
        const reports = {};
        let reportToDelete = null;
        let isVerified = false;
        const SECURITY_CODE = "NBC4064";
        let pendingVerification = false;

        // Add Malaysia public holidays (2024 Negeri Sembilan)
        const publicHolidays = {
            '2024': {
                '1': [1, 14],  // New Year, Federal Territory Day
                '2': [10, 11, 12],  // Chinese New Year
                '3': [19],  // Nuzul Al-Quran
                '4': [10, 11],  // Hari Raya Puasa
                '5': [1, 15],  // Labour Day, Wesak Day
                '6': [17, 18],  // Hari Raya Haji
                '7': [7],  // Awal Muharram
                '8': [31],  // National Day
                '9': [16],  // Malaysia Day
                '10': [17],  // Prophet Muhammad's Birthday
                '12': [25]  // Christmas
            }
        };

        function isHoliday(year, month, day) {
            const date = new Date(year, month, day);
            const dayOfWeek = date.getDay();
            
            // Check if date is before Feb 17, 2025
            const startDate = new Date(2025, 1, 17); // Month is 0-based
            if (date < startDate) return true;
            
            // Check if weekend
            if (dayOfWeek === 0 || dayOfWeek === 6) return true;
            
            // Check if public holiday
            const yearHolidays = publicHolidays[year];
            if (yearHolidays && yearHolidays[month + 1]) {
                return yearHolidays[month + 1].includes(day);
            }
            
            return false;
        }

        // Initialize calendar
        function initCalendar() {
            const monthDisplay = document.getElementById('monthDisplay');
            const calendarDays = document.getElementById('calendarDays');
            
            function updateCalendar() {
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();
                
                monthDisplay.textContent = new Date(year, month).toLocaleDateString('ms-MY', {
                    month: 'long',
                    year: 'numeric'
                });
                
                calendarDays.innerHTML = '';
                
                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);
                const startingDay = firstDay.getDay();
                
                // Add empty cells for days before the first day of the month
                for (let i = 0; i < startingDay; i++) {
                    const emptyDay = document.createElement('div');
                    emptyDay.className = 'day';
                    calendarDays.appendChild(emptyDay);
                }
                
                // Add days of the month
                for (let day = 1; day <= lastDay.getDate(); day++) {
                    const dayElement = document.createElement('div');
                    dayElement.className = 'day';
                    dayElement.textContent = day;
                    
                    const dateString = `${year}-${month + 1}-${day}`;
                    const currentDate = new Date(year, month, day);

                    // Check if holiday
                    if (isHoliday(year, month, day)) {
                        dayElement.classList.add('holiday');
                    } else {
                        // Add click event only if not a holiday
                        dayElement.addEventListener('click', () => openReportModal(year, month, day));
                        
                        // Check report status
                        if (reports[dateString]) {
                            if (reports[dateString].checked) {
                                dayElement.classList.add('checked');
                            } else {
                                dayElement.classList.add('submitted');
                            }
                        } else {
                            // Check if today
                            if (currentDate.toDateString() === new Date().toDateString()) {
                                dayElement.classList.add('today');
                            }
                            // Check if past due
                            else if (currentDate < new Date() && !isHoliday(year, month, day)) {
                                dayElement.classList.add('past-due');
                            }
                        }
                    }
                    
                    calendarDays.appendChild(dayElement);
                }
            }
            
            // Event listeners for month navigation
            document.getElementById('prevMonth').addEventListener('click', () => {
                currentDate.setMonth(currentDate.getMonth() - 1);
                updateCalendar();
            });
            
            document.getElementById('nextMonth').addEventListener('click', () => {
                currentDate.setMonth(currentDate.getMonth() + 1);
                updateCalendar();
            });
            
            updateCalendar();
        }

        // Modal functionality
        function openReportModal(year, month, day) {
            const modal = document.getElementById('reportModal');
            const selectedDateElement = document.getElementById('selectedDate');
            selectedDate = new Date(year, month, day);
            
            selectedDateElement.textContent = selectedDate.toLocaleDateString('ms-MY', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            // Load existing report if any
            const dateString = `${year}-${month + 1}-${day}`;
            console.log('Opening report for date:', dateString);
            console.log('Available reports:', reports);
            
            const deleteButton = document.getElementById('deleteReport');
            
            // Show delete button only if report exists
            deleteButton.style.display = reports[dateString] ? 'block' : 'none';
            
            if (reports[dateString]) {
                console.log('Found existing report:', reports[dateString]);
                const report = reports[dateString];
                
                // Reset form first
                document.getElementById('dutyForm').reset();
                
                // Load basic info
                document.getElementById('teacherName').value = report.teacherName;
                document.getElementById('dutyLocation').value = report.dutyLocation;
                
                // Load cleanliness ratings
                if (report.cleanliness) {
                    setSelectedValue('classroom', report.cleanliness.classroom);
                    setSelectedValue('corridor', report.cleanliness.corridor);
                    setSelectedValue('maleBathroom', report.cleanliness.maleBathroom);
                    setSelectedValue('femaleBathroom', report.cleanliness.femaleBathroom);
                    setSelectedValue('schoolArea', report.cleanliness.schoolArea);
                    setSelectedValue('canteen', report.cleanliness.canteen);
                }
                
                // Load discipline case
                if (report.disciplineCase) {
                    const hasDisciplineCase = report.disciplineCase.exists ? 'yes' : 'no';
                    document.getElementById('hasDisciplineCase').value = hasDisciplineCase;
                    
                    // Show/hide discipline details based on selection
                    const disciplineDetails = document.getElementById('disciplineDetails');
                    disciplineDetails.style.display = hasDisciplineCase === 'yes' ? 'block' : 'none';
                    
                    if (hasDisciplineCase === 'yes') {
                        document.getElementById('caseDescription').value = report.disciplineCase.description || '';
                        document.getElementById('incidentLocation').value = report.disciplineCase.location || '';
                        document.getElementById('incidentTime').value = report.disciplineCase.time || '';
                        document.getElementById('actionTaken').value = report.disciplineCase.action || '';
                    }
                }
                
                // Load lost and found
                document.getElementById('lostFound').value = report.lostFound || '';
                
                // Set verification status
                isVerified = report.checked;
            } else {
                console.log('No existing report found, resetting form');
                document.getElementById('dutyForm').reset();
                document.getElementById('disciplineDetails').style.display = 'none';
                document.getElementById('dutyLocation').value = 'Kawasan Sekolah';
                isVerified = false;
            }
            
            modal.style.display = 'block';
        }

        // Close modal functionality
        document.querySelector('.close').addEventListener('click', () => {
            document.getElementById('reportModal').style.display = 'none';
        });

        // Form submission
        document.getElementById('dutyForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Validate required fields
            const teacherName = document.getElementById('teacherName').value.trim();
            if (!teacherName) {
                alert('Sila masukkan nama guru bertugas.');
                return;
            }

            // Check if all Likert scales are selected
            const areas = ['classroom', 'corridor', 'maleBathroom', 'femaleBathroom', 'schoolArea', 'canteen'];
            for (const area of areas) {
                if (!document.querySelector(`input[name="${area}"]:checked`)) {
                    alert('Sila lengkapkan semua penilaian kebersihan dan disiplin.');
                    return;
                }
            }
            
            const dateString = `${selectedDate.getFullYear()}-${selectedDate.getMonth() + 1}-${selectedDate.getDate()}`;
            const isUpdate = reports[dateString] ? true : false;
            
            // Get existing discipline case data if exists
            const existingReport = reports[dateString] || {};
            const existingDisciplineCase = existingReport.disciplineCase || {};
            
            reports[dateString] = {
                teacherName: teacherName,
                dutyLocation: document.getElementById('dutyLocation').value,
                cleanliness: {
                    classroom: document.querySelector('input[name="classroom"]:checked').value,
                    corridor: document.querySelector('input[name="corridor"]:checked').value,
                    maleBathroom: document.querySelector('input[name="maleBathroom"]:checked').value,
                    femaleBathroom: document.querySelector('input[name="femaleBathroom"]:checked').value,
                    schoolArea: document.querySelector('input[name="schoolArea"]:checked').value,
                    canteen: document.querySelector('input[name="canteen"]:checked').value
                },
                disciplineCase: {
                    exists: document.getElementById('hasDisciplineCase').value === 'yes',
                        description: document.getElementById('caseDescription').value,
                        location: document.getElementById('incidentLocation').value,
                        time: document.getElementById('incidentTime').value,
                        action: document.getElementById('actionTaken').value
                },
                lostFound: document.getElementById('lostFound').value || existingReport.lostFound || '',
                checked: isVerified
            };
            
            // Save locally and to Sheets
            localStorage.setItem('teacherReports', JSON.stringify(reports));
            const saved = await saveReportsToSheets(reports);
            if (!saved) {
                alert('Gagal menyimpan ke Google Sheets. Data hanya disimpan secara lokal.');
            }
            
            // Update calendar
            initCalendar();
            
            // Show success message
            alert(isUpdate ? 'Laporan berjaya dikemaskini!' : 'Laporan berjaya dihantar!');
            
            // Close modal
            document.getElementById('reportModal').style.display = 'none';
        });

        // Load data when page loads
        window.addEventListener('load', async () => {
            const savedReports = localStorage.getItem('teacherReports');
            if (savedReports) {
                Object.assign(reports, JSON.parse(savedReports));
            }
            
            const sheetsReports = await loadReportsFromSheets();
            if (sheetsReports) {
                Object.assign(reports, sheetsReports);
                localStorage.setItem('teacherReports', JSON.stringify(reports));
            }
            
            initCalendar();
        });

        // Handle discipline case selection
        document.getElementById('hasDisciplineCase').addEventListener('change', function() {
            const disciplineDetails = document.getElementById('disciplineDetails');
            disciplineDetails.style.display = this.value === 'yes' ? 'block' : 'none';
            if (this.value === 'no') {
                document.getElementById('caseDescription').value = '';
                document.getElementById('incidentLocation').value = '';
                document.getElementById('incidentTime').value = '';
                document.getElementById('actionTaken').value = '';
            }
        });

        function getSelectedValue(name) {
            return document.querySelector(`input[name="${name}"]:checked`)?.value || '';
        }

        function setSelectedValue(name, value) {
            if (!value) return;
            const radio = document.querySelector(`input[name="${name}"][value="${value}"]`);
            if (radio) {
                radio.checked = true;
            } else {
                console.warn(`Could not find radio button for ${name} with value ${value}`);
            }
        }

        // Add click outside modal to close
        window.addEventListener('click', (event) => {
            const modal = document.getElementById('reportModal');
            const confirmDialog = document.getElementById('confirmDialog');
            if (event.target === modal) {
                modal.style.display = 'none';
            }
            if (event.target === confirmDialog) {
                confirmDialog.style.display = 'none';
                reportToDelete = null;
            }
        });

        // Delete report functionality
        document.getElementById('deleteReport').addEventListener('click', function() {
            const dateString = `${selectedDate.getFullYear()}-${selectedDate.getMonth() + 1}-${selectedDate.getDate()}`;
            if (reports[dateString]) {
                reportToDelete = dateString;
                document.getElementById('confirmDialog').style.display = 'block';
            } else {
                alert('Tiada laporan untuk dipadam.');
            }
        });

        function confirmDelete(confirmed) {
            const dialog = document.getElementById('confirmDialog');
            dialog.style.display = 'none';
            
            if (confirmed && reportToDelete) {
                // Delete the report
                delete reports[reportToDelete];
                
                // Update localStorage
                localStorage.setItem('teacherReports', JSON.stringify(reports));
                
                // Update calendar display
                document.querySelectorAll('.day').forEach(day => {
                    const currentDate = new Date(reportToDelete);
                    if (day.textContent === currentDate.getDate().toString()) {
                        // Remove all possible status classes
                        day.classList.remove('submitted', 'checked', 'past-due');
                        
                        // Add past-due class if the date is in the past and not a holiday
                        const today = new Date();
                        if (currentDate < today && !isHoliday(currentDate.getFullYear(), currentDate.getMonth(), currentDate.getDate())) {
                            day.classList.add('past-due');
                        }
                    }
                });
                
                // Close modal and show success message
                document.getElementById('reportModal').style.display = 'none';
                alert('Laporan berjaya dipadam!');
                
                // Reset the form
                document.getElementById('dutyForm').reset();
                document.getElementById('dutyLocation').value = 'Kawasan Sekolah';
                document.getElementById('disciplineDetails').style.display = 'none';
            }
            reportToDelete = null;
        }

        function verifySecurityCode(verify) {
            const dialog = document.getElementById('securityDialog');
            const errorMsg = document.getElementById('securityError');
            
            if (!verify) {
                dialog.style.display = 'none';
                document.getElementById('securityCode').value = '';
                errorMsg.style.display = 'none';
                pendingVerification = false;
                return;
            }
            
            const inputCode = document.getElementById('securityCode').value;
            
            if (inputCode === SECURITY_CODE) {
                dialog.style.display = 'none';
                document.getElementById('securityCode').value = '';
                errorMsg.style.display = 'none';
                
                if (pendingVerification === 'all') {
                    // Verify all reports
                    let reportsUpdated = false;
                    
                    // Loop through all reports
                    for (let dateString in reports) {
                        if (reports[dateString] && !reports[dateString].checked) {
                            reports[dateString].checked = true;
                            reportsUpdated = true;
                        }
                    }
                    
                    if (reportsUpdated) {
                        // Save to localStorage
                        localStorage.setItem('teacherReports', JSON.stringify(reports));
                        
                        // Update calendar display
                        initCalendar();
                        
                        alert('Semua laporan telah disahkan!');
                    } else {
                        alert('Tiada laporan yang perlu disahkan.');
                    }
                } else {
                // Actually verify the report
                isVerified = true;
                const notVerifiedBtn = document.querySelector('.verify-button.not-verified');
                const verifiedBtn = document.querySelector('.verify-button.verified');
                verifiedBtn.classList.add('active');
                notVerifiedBtn.classList.remove('active');
                }
                
                pendingVerification = false;
            } else {
                errorMsg.style.display = 'block';
            }
        }

        // Add Enter key support for security code
        document.getElementById('securityCode').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                verifySecurityCode(true);
            }
        });

        // Modify verify all button functionality
        document.getElementById('verifyAllBtn').addEventListener('click', function() {
            document.getElementById('securityDialog').style.display = 'block';
            document.getElementById('securityError').style.display = 'none';
            document.getElementById('securityCode').value = '';
            pendingVerification = 'all';
        });
    </script>
</body>
</html> 